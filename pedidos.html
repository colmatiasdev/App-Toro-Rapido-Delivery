<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Toro Rápido - Pedidos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Inter:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="pedidos.css">
    <link rel="stylesheet" href="footer.css">
    <script src="config.js"></script>
</head>
<body>

<div id="overlay-carga">
    <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--whatsapp-color);"></i>
    <p style="margin-top:15px; font-weight:700;">Procesando pedido...</p>
</div>

<div class="contenedor">
    <a href="menu.html" class="boton-volver-menu" onclick="sessionStorage.setItem('toro_scroll_resumen','1')">
        <i class="fa-solid fa-pen-to-square"></i> Modificar pedido
    </a>

    <div class="resumen-menu" id="resumen-menu" style="display:none;">
        <div class="resumen-menu-title">Resumen del pedido realizado</div>
        <div id="resumen-menu-items"></div>
        <div class="resumen-menu-row">
            <span>Subtotal</span>
            <strong id="resumen-menu-subtotal">$ 0</strong>
        </div>
        <div class="resumen-menu-row resumen-envio-row" id="resumen-envio-row">
            <span>Envío</span>
            <strong id="resumen-menu-envio">$ 0</strong>
        </div>
        <div class="resumen-menu-total">
            <span>Total</span>
            <strong id="resumen-menu-total">$ 0</strong>
        </div>
        <div class="resumen-menu-note">Revisá tu pedido antes de enviarlo por WhatsApp.</div>
    </div>

    <div class="resumen-caja" id="caja-resumen">
        <div style="font-weight: 800; margin-bottom: 15px; color: var(--azul-oscuro); text-align: center; text-transform: uppercase;">Resumen de Pedido</div>
        <div id="lista-resumen"></div>
        
        <div class="fila-resumen" id="fila-envio" style="border-bottom: none; color: #166534;">
            <span>Gastos de Envío</span>
            <strong id="monto-envio">$ 0</strong>
        </div>

        <div class="total-badge">
            <span style="font-weight:700;">TOTAL ESTIMADO</span>
            <span id="monto-total-display" style="font-weight:900; color:var(--rojo-toro); font-size:1.4em;">$ 0</span>
        </div>
        <div class="zona-aviso">
            ⚠️ Una vez recibido el pedido, analizaremos tu domicilio para confirmar si contamos con entregas en tu zona.
        </div>
    </div>

    <div class="datos-cliente">
        <div style="font-weight: 800; color: #166534; margin-bottom: 15px; font-size: 1em; text-align: center;"><i class="fa-solid fa-truck-fast"></i> DATOS DE ENTREGA</div>
        
        <div class="input-group">
            <label>Nombre de quien recibe:</label>
            <i class="fa-solid fa-user"></i>
            <input type="text" id="cust-name" class="input-field" placeholder="Ej: Juan Pérez" value="María Cabrera">
        </div>

        <div class="input-group">
            <label>WhatsApp:</label>
            <i class="fa-solid fa-phone"></i>
            <input type="tel" id="cust-phone" class="input-field" placeholder="Ej: 3814556677" value="3813434720">
        </div>

        <div class="input-group">
            <label>Domicilio:</label>
            <i class="fa-solid fa-location-dot"></i>
            <input type="text" id="cust-address" class="input-field" placeholder="Calle, número, piso y depto..." value="San Martín 742, Piso 2, Depto B">
        </div>
    </div>

    <button onclick="enviarPedido()" class="boton-pedido">
        <i class="fa-brands fa-whatsapp fa-xl"></i> ENVIAR POR WHATSAPP
    </button>
    <div id="site-footer"></div>
</div>

<script>
    const TELEFONO_NEGOCIO = "5493814130520"; 
    const URL_APPS_SCRIPT = window.APP_CONFIG?.appsScriptUrl || "https://script.google.com/macros/s/AKfycbzllzUCk1UqUV08XINHmy6Omvcl6JZ8_jRYY8k1WS2N_Kgnyec_mEp9CdVUdhrafC_B/exec";

    const COSTO_ENVIO_BASE = 1500; 
    const MINIMO_ENVIO_GRATIS = 25000;

    function formatearMoneda(valor) { return `$ ${Number(valor).toLocaleString('es-AR')}`; }


    async function enviarPedido() {
        const n = document.getElementById('cust-name').value.trim();
        const w = document.getElementById('cust-phone').value.trim();
        const d = document.getElementById('cust-address').value.trim();
        if(!n || !d || !w) { alert("⚠️ Por favor, completa tus datos de entrega."); return; }

        const payload = leerPedidoMenu();
        if (!payload || !Array.isArray(payload.items) || payload.items.length === 0) {
            alert("❌ No encontramos productos del menú. Volvé a seleccionar tu pedido.");
            return;
        }

        const productosParaSheet = payload.items.map((item) => ({
            categoria: item.category || "",
            idproducto: item.id,
            producto: item.name,
            precio: item.price,
            cantidad: item.qty,
            subtotal: item.subtotal
        }));

        const itemsWhatsApp = payload.items.map((item) => {
            const isPromo = (item.category || "").toLowerCase().includes("promo");
            return `* (x${item.qty}) ${isPromo ? "[PROMO] " : ""}${item.name} ${formatearMoneda(item.subtotal)}`;
        }).join("\n");

        const subtotal = payload.subtotal || 0;
        if(subtotal === 0) { alert("❌ Selecciona productos antes de enviar."); return; }

        document.getElementById('overlay-carga').style.display = 'flex';
        const costoEnvio = payload.delivery ?? (subtotal >= MINIMO_ENVIO_GRATIS ? 0 : COSTO_ENVIO_BASE);
        const ahora = new Date();
        const idPedido = "PED-" + ahora.getTime();

        try {
            await fetch(URL_APPS_SCRIPT, {
                method: "POST",
                mode: "no-cors", 
                body: JSON.stringify({
                    idpedido: idPedido,
                    fecha: ahora.toLocaleDateString('es-AR'),
                    hora: ahora.toLocaleTimeString('es-AR'),
                    cliente: n, whatsapp: w, direccion: d,
                    total: subtotal + costoEnvio,
                    productos: productosParaSheet
                })
            });
            sessionStorage.removeItem("toro_pedido");
        } catch (e) { console.error(e); }

        let msg = `*TORO RÁPIDO - DELIVERY*\n_ID: ${idPedido}_\n\n*Cliente* ${n}\n*Domicilio:* ${d}\n*WSP:* ${w}\n\n*Detalle del Pedido*\n${itemsWhatsApp}`;
        msg += `\n\n*SUBTOTAL:* ${formatearMoneda(subtotal)}`;
        msg += `\n*ENVÍO:* ${costoEnvio === 0 ? "¡GRATIS!" : formatearMoneda(costoEnvio)}`;
        msg += `\n*TOTAL:* ${formatearMoneda(subtotal + costoEnvio)}\n\n_⚠️ Sujeto a confirmación de zona._`;

        document.getElementById('overlay-carga').style.display = 'none';
        window.open(`https://wa.me/${TELEFONO_NEGOCIO}?text=${encodeURIComponent(msg)}`, '_blank');
    }

    function leerPedidoMenu() {
        const params = new URLSearchParams(window.location.search);
        let payload = null;
        const raw = params.get("pedido");
        if (raw) {
            try {
                payload = JSON.parse(decodeURIComponent(raw));
            } catch (e) {
                console.error(e);
            }
        }
        if (!payload) {
            try {
                const stored = sessionStorage.getItem("toro_pedido");
                if (stored) payload = JSON.parse(stored);
            } catch (e) {
                console.error(e);
            }
        }
        return payload;
    }

    function renderResumenMenu() {
        const container = document.getElementById("resumen-menu");
        const list = document.getElementById("resumen-menu-items");
        const subtotalEl = document.getElementById("resumen-menu-subtotal");
        const envioEl = document.getElementById("resumen-menu-envio");
        const totalEl = document.getElementById("resumen-menu-total");
        if (!container || !list || !subtotalEl || !envioEl || !totalEl) return;

        const payload = leerPedidoMenu();
        if (!payload || !Array.isArray(payload.items) || payload.items.length === 0) return;

        list.innerHTML = payload.items.map((item) => {
            const isPromo = (item.category || "").toLowerCase().includes("promo");
            const label = `${item.qty}x ${item.name}${isPromo ? " [PROMO]" : ""}`;
            return `
                <div class="resumen-menu-item${isPromo ? " item-promo" : ""}">
                    <span>${label}</span>
                    <strong>${formatearMoneda(item.subtotal)}</strong>
                </div>
            `;
        }).join("");

        subtotalEl.innerText = formatearMoneda(payload.subtotal || 0);
        const envioRow = document.getElementById("resumen-envio-row");
        if ((payload.subtotal || 0) > 0 && (payload.delivery || 0) === 0) {
            envioEl.innerText = "¡GRATIS!";
            if (envioRow) envioRow.classList.add("envio-gratis");
        } else {
            envioEl.innerText = formatearMoneda(payload.delivery || 0);
            if (envioRow) envioRow.classList.remove("envio-gratis");
        }
        totalEl.innerText = formatearMoneda(payload.total || 0);
        container.style.display = "block";
    }

    function initPedidos() {
        renderResumenMenu();
    }

    async function cargarPie() {
        const container = document.getElementById("site-footer");
        if (!container) return;
        try {
            const response = await fetch("footer.html");
            if (!response.ok) return;
            container.innerHTML = await response.text();
        } catch (e) {
            console.error(e);
        }
    }

    async function initPedidos() {
        renderResumenMenu();
        await cargarPie();
    }

    window.onload = initPedidos;
</script>
</body>
</html>
